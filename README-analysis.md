# BigQuery SQL Analysis of SaaS User Data

## Overview

This document details the SQL analysis performed on the synthetic SaaS user data (generated by the Python script in this repository) using Google BigQuery. The goal of this analysis was to aggregate and transform the raw data to derive monthly insights into key SaaS metrics at the site level, specifically considering user registration dates when calculating activity.

## Data Sources (in BigQuery)

The analysis utilizes the following tables in Google BigQuery (within the `saas-user-analysis` dataset):

* `saas_storage`: Daily storage usage information.
* `saas_user_activity`: Daily user activity events.
* `saas_background_jobs`: Information about background job executions.
* `` `saas-user-analysis-456519`.saas_user_analysis.`saas-user` ``: User registration information.

## SQL Query

The following SQL query was executed in Google BigQuery to perform the analysis:

```sql
WITH
    MonthlyStorage AS (
        SELECT
            DATE_TRUNC(date, MONTH) AS month,
            customer_id,
            site_id,
            'Storage' AS `Usage Type`,
            ROUND(AVG(storage_bytes) / (1024 * 1024 * 1024), 2) AS value
        FROM
            `saas-user-analysis-456519`.saas_user_analysis.saas_storage
        WHERE
            storage_bytes > 0
        GROUP BY
            1,
            2,
            3
    ),
    MonthlyActivities AS (
        SELECT
            DATE_TRUNC(ua.date, MONTH) AS month,
            ua.customer_id,
            ua.site_id,
            'Activity' AS `Usage Type`,
            CAST(SUM(ua.event_count) AS INT64) AS value
        FROM
            `saas-user-analysis-456519`.saas_user_analysis.saas_user_activity ua
        JOIN
            `saas-user-analysis-456519`.saas_user_analysis.`saas-user` u ON ua.user_email = u.user_email
        WHERE
            DATE(ua.date) >= DATE_ADD(DATE(u.registration_date), INTERVAL '30' DAY)
        GROUP BY
            1,
            2,
            3
    ),
    LastDayActiveUsers AS (
        SELECT
            DATE_TRUNC(ua.date, MONTH) AS month,
            ua.customer_id,
            ua.site_id,
            'Active User' AS `Usage Type`,
            CAST(COUNT(DISTINCT ua.user_email) AS INT64) AS value
        FROM
            `saas-user-analysis-456519`.saas_user_analysis.saas_user_activity ua
        JOIN
            `saas-user-analysis-456519`.saas_user_analysis.`saas-user` u ON ua.user_email = u.user_email
        WHERE
            DATE(ua.date) = LAST_DAY(ua.date)
            AND DATE(ua.date) >= DATE_ADD(DATE(u.registration_date), INTERVAL '30' DAY)
        GROUP BY
            1,
            2,
            3
    ),
    AggregatedBackgroundJobs AS (
        SELECT
            DATE_TRUNC(bj.date, MONTH) AS month,
            bj.site_id,
            'Background Job' AS `Usage Type`,
            ROUND(AVG(bj.background_job_min), 1) AS value
        FROM
            `saas-user-analysis-456519`.saas_user_analysis.saas_background_jobs bj
        WHERE
            bj.background_job_type NOT IN ('bridge', 'alert')
        GROUP BY
            1,
            2,
            3
    ),
    MonthlyBackgroundJobsWithCustomer AS (
        SELECT
            abj.month,
            ua.customer_id,
            abj.site_id,
            'Background Job' AS `Usage Type`,
            abj.value
        FROM
            AggregatedBackgroundJobs abj
        JOIN
            `saas-user-analysis-456519`.saas_user_analysis.saas_user_activity ua ON abj.site_id = ua.site_id
            AND abj.month = DATE_TRUNC(ua.date, MONTH)
        GROUP BY
            1,
            2,
            3,
            4,
            5
    ),
    CombinedData AS (
        SELECT
            month,
            customer_id,
            site_id,
            `Usage Type`,
            value
        FROM
            MonthlyStorage
        UNION ALL
        SELECT
            month,
            customer_id,
            site_id,
            `Usage Type`,
            value
        FROM
            MonthlyActivities
        UNION ALL
        SELECT
            month,
            customer_id,
            site_id,
            `Usage Type`,
            value
        FROM
            LastDayActiveUsers
        UNION ALL
        SELECT
            month,
            customer_id,
            site_id,
            `Usage Type`,
            value
        FROM
            MonthlyBackgroundJobsWithCustomer
    )
SELECT
    month,
    customer_id,
    site_id,
    `Usage Type`,
    value
FROM
    CombinedData
ORDER BY
    month,
    customer_id,
    site_id,
    `Usage Type`;

```

## SQL Logic Walkthrough
The SQL query consists of several Common Table Expressions (CTEs) that build upon each other to achieve the final result:

* **MonthlyStorage**:
Aggregates the saas_storage table to calculate the average monthly storage in gigabytes for each customer and site.
Filters out storage entries with zero usage.

* **MonthlyActivities**:
Aggregates the saas_user_activity table to calculate the total monthly activity count for each customer and site.
Joins with the `saas-user-analysis-456519`.saas_user_analysis.`saas-user` table to exclude activities that occurred within the first 30 days after a user's registration date.
The result is cast to an integer.

* **LastDayActiveUsers**:
Counts the number of distinct active users for each customer and site on the last day of each month from the saas_user_activity table.
Joins with the `saas-user-analysis-456519`.saas_user_analysis.`saas-user` table to only count users whose activity on the last day of the month was 30 days or more after their registration.
The result is cast to an integer.

* **AggregatedBackgroundJobs**:
Aggregates the saas_background_jobs table to calculate the average monthly duration of background jobs for each site.
Excludes background jobs where background_job_type is 'bridge' or 'alert'.
The result is rounded to one decimal place.

* **MonthlyBackgroundJobsWithCustomer**:
Joins the aggregated background job data with the saas_user_activity table on site_id and the month of the date to associate a customer_id with the background job metrics.

* **CombinedData**:
Uses UNION ALL to combine the monthly summaries from all the previous CTEs into a single table.
Includes columns for month, customer_id, site_id, Usage Type (Storage, Activity, Active User, Background Job), and the corresponding value.
The final SELECT statement retrieves and orders the data from the CombinedData CTE.

## Key Insights and Results
The executed query provides a monthly summary of key SaaS usage metrics at the site level. The results include:

* **Average Storage Consumption (GB)**: Shows the average storage used by each customer at each site per month.
* **Total User Activities**: Indicates the total number of user interactions within each customer and site per month, excluding activities within the first 30 days of registration.
* **Number of Active Users**: Represents the count of unique users active on the last day of each month for each customer and site, considering only users whose activity occurred 30 days or more after their registration.
* **Average Background Job Duration (minutes)**: Shows the average duration of background jobs (excluding 'bridge' and 'alert' types) per site per month.

## Tools Used
* Google BigQuery
* SQL

## Link to Main Project README
[README.md](https://github.com/Cath-L/saas-user-analysis/blob/main/README.md)

